# Copilot Instructions: Data Warehouse Development

This document guides GitHub Copilot in assisting with the development of the data warehouse. It is structured into chapters, each focusing on a specific methodology or layer of the warehouse.

Your primary role is to act as an intelligent assistant, helping the user translate source schema information into a cohesive, well-defined data model by populating a series of YAML configuration files for the SQLMesh framework.

## Chapter 1: Building the HOOK Layer

This chapter focuses on the HOOK methodology. The process is centered around analyzing one or more ingestion schemas and populating the HOOK metadata layer defined in these files:
- `sqlmesh/models/dab/hook/concepts.yaml`
- `sqlmesh/models/dab/hook/keysets.yaml`
- `sqlmesh/models/dab/hook/frames.yaml`

The SQL models for these frames are generated by `sqlmesh/models/dab/hook/hook_blueprint.py` unless `skip_generation: true` is set on a frame.

### The HOOK Development Workflow

Follow this structured workflow. Always explain which file you are modifying and why, adhering to the established conventions.

#### Step 1: Define or Identify Business Concepts

**Goal:** To establish a consolidated list of core business concepts.

1.  **Analyze Schemas:** Scan for source schema files (`dlt/*/schemas/import/*.schema.yaml`). Identify core nouns representing business entities (e.g., `customers`, `products`).
2.  **Check Existing Concepts:** Before adding a new concept, review `sqlmesh/models/dab/hook/concepts.yaml` to see if a suitable one already exists.
3.  **Propose and Define Concepts:** If a new concept is needed, propose a `name` (lowercase) and a `type` (e.g., `core`). Add it to `concepts.yaml`.

**Example:**
> **Copilot:** "I've analyzed the `dlt/new_source/` schema and see a `leads` table. We don't have a `lead` concept yet. I'll add it to `concepts.yaml`."

*(Copilot proposes changes to `concepts.yaml`)*
```yaml
- name: lead
  type: core
```

#### Step 2: Define Key Sets

**Goal:** To create globally unique identifiers for each distinct business key.

1.  **Identify Business Keys:** For a given concept, identify its key(s) in the source schema (e.g., `CustomerID` for `customer`, `ProductName` for `product`).
2.  **Propose a Key Set:** For each key, define a Key Set in `sqlmesh/models/dab/hook/keysets.yaml`.
    - `name`: Must be globally unique. Convention: `<source_system>.<concept>.<qualifier>` (e.g., `northwind.customer.id`).
    - `concept`: The name from `concepts.yaml`.
    - `qualifier`: A short descriptor of the key type (e.g., `id`, `name`).
    - `source_system`: The name of the source system.

**Example:**
> **Copilot:** "For the `lead` concept from the `new_source` system, the key is the `LeadID` column. I will create a new keyset `new_source.lead.id`."

*(Copilot proposes changes to `keysets.yaml`)*
```yaml
- name: new_source.lead.id
  concept: lead
  qualifier: id
  source_system: new_source
```

#### Step 3: Define Frames and their Hooks

**Goal:** To map source tables to Frames and define the Hooks that connect them to the warehouse via `sqlmesh/models/dab/hook/frames.yaml`.

1.  **Define the Frame:** Add a new entry for the source table (e.g., `northwind__customers`).

2.  **Define Simple Hooks:** Under the `hooks:` list, define each simple hook.
    - `name`: The final column name. Convention: `_hook__<concept>__<qualifier>`.
    - `primary`: `true` for the hook that uniquely identifies the record in the frame. `false` for others. There should be exactly one primary hook per frame (can be simple or composite).
    - `concept`: The concept name.
    - `qualifier`: The qualifier (e.g., `id`, `name`).
    - `keyset`: The full keyset name from `keysets.yml`.
    - `expression`: The source column name from the input table.

3.  **Define Composite Hooks (if needed):** If the primary key is a combination of other hooks in the frame, define it under `composite_hooks:`.
    - `name`: The final column name for the composite hook.
    - `primary`: `true` if this is the primary identifier for the frame.
    - `hooks`: A list of the *names* of other simple hooks defined within this frame that make up the composite key.

**Example:**
> **Copilot:** "I will now add the `northwind__order_details` frame. It links orders and products. The primary key is the combination of the order and the product, so I'll create a composite hook."

*(Copilot proposes changes to `frames.yaml`)*
```yaml
- name: northwind__order_details
  hooks:
  - name: _hook__order__id
    primary: false
    concept: order
    qualifier: id
    keyset: northwind.order.id
    expression: order_id

  - name: _hook__product__id
    primary: false
    concept: product
    qualifier: id
    keyset: northwind.product.id
    expression: product_id

  composite_hooks:
  - name: _hook__order__product
    primary: true
    hooks:
    - _hook__order__id
    - _hook__product__id
```